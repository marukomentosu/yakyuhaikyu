<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Elite Scout - Matchup Master | htmlãƒãƒ³</title>
    <style>
        :root {
            --primary: #0a2e5c; --accent: #e63946; --bg: #f8f9fa;
            --btn-idle: #ffffff; --btn-active: #0a2e5c;
            --danger: #d90429; --success: #2b9348;
        }

        body {
            font-family: -apple-system, sans-serif; background-color: var(--bg);
            margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center;
        }

        /* è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ (æŠ˜ã‚ŠãŸãŸã¿) */
        details { width: 100%; background: #fff; border-bottom: 2px solid #ddd; }
        summary { padding: 12px; font-weight: bold; color: var(--primary); cursor: pointer; background: #eef2f7; text-align: center; list-style: none; }
        .settings-content { padding: 15px; display: flex; flex-direction: column; gap: 10px; }

        .switch-container { display: flex; align-items: center; justify-content: space-between; background: #f0f0f0; padding: 5px 12px; border-radius: 20px; }
        .switch { position: relative; width: 44px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider-toggle { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #2196F3; transition: .3s; border-radius: 24px; }
        .slider-toggle:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; }
        input:checked + .slider-toggle { background-color: #f44336; }
        input:checked + .slider-toggle:before { transform: translateX(22px); }

        /* ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ */
        .app-main { width: 100%; max-width: 400px; padding: 10px; box-sizing: border-box; }

        #pitch-canvas-container {
            position: relative; width: 100%; aspect-ratio: 3/3.6; background: #333; border-radius: 10px; border: 3px solid #222; touch-action: none;
        }
        #strike-zone-box { position: absolute; top: 22%; left: 21%; width: 58%; height: 56%; border: 2px solid rgba(255,255,255,0.4); pointer-events: none; }
        canvas#heatmap-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; opacity: 0.8; }
        .marker { position: absolute; width: 12px; height: 12px; border-radius: 50%; transform: translate(-50%, -50%); border: 1.5px solid #fff; pointer-events: none; }

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
        .control-grid { width: 100%; display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
        .flex-row { display: flex; gap: 8px; justify-content: center; align-items: center; }
        
        .pitch-compass { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; width: 210px; }
        .pitch-btn { aspect-ratio: 1/1; border: 1px solid #ddd; border-radius: 8px; background: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; font-size: 1rem; }
        .pitch-btn.active { background: var(--primary); color: white; }
        .pitch-btn span { font-size: 0.5rem; font-weight: bold; }

        .result-group { display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px; flex: 1; }
        .res-btn { padding: 8px 2px; border: 1px solid #ddd; border-radius: 6px; background: #fff; font-size: 0.7rem; font-weight: bold; cursor: pointer; }
        .res-btn.active { background: #666; color: white; }

        .btn { padding: 14px; border: none; border-radius: 8px; font-weight: bold; color: #fff; font-size: 1rem; cursor: pointer; flex: 1; }
        .btn-record { background: var(--primary); }
        .btn-csv { background: var(--success); }
        .btn-clear { background: #999; font-size: 0.7rem; padding: 5px; }

        /* å±¥æ­´ãƒ»åˆ†æ */
        .analysis-select { width: 100%; padding: 10px; border-radius: 8px; margin-top: 5px; border: 1px solid #ccc; font-weight: bold; }
        .history { width: 100%; margin-top: 15px; font-size: 0.7rem; max-height: 300px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; background: #fff; }
        th, td { padding: 8px 4px; border-bottom: 1px solid #eee; text-align: center; }
        th { background: var(--primary); color: white; position: sticky; top: 0; }
        .matchup-tag { font-size: 0.6rem; padding: 2px 4px; border-radius: 4px; background: #eee; color: #333; }
    </style>
</head>
<body>

    <details id="settings-drawer">
        <summary>âš™ï¸ æŠ•æ‰‹ãƒ»æ‰“è€…ãƒ»ãƒãƒƒãƒã‚¢ãƒƒãƒ—è¨­å®š</summary>
        <div class="settings-content">
            <div style="display:grid; grid-template-columns: 1.5fr 1fr; gap:8px;">
                <input type="text" id="p-name" placeholder="æŠ•æ‰‹å" value="æŠ•æ‰‹A">
                <div class="switch-container">
                    <span style="font-size:0.7rem">å³</span>
                    <label class="switch"><input type="checkbox" id="p-hand" onchange="renderCompass()"><span class="slider-toggle"></span></label>
                    <span style="font-size:0.7rem">å·¦</span>
                </div>
            </div>
            <div style="display:grid; grid-template-columns: 1.5fr 1fr; gap:8px;">
                <input type="text" id="b-name" placeholder="æ‰“è€…å" value="æ‰“è€…A">
                <div class="switch-container">
                    <span style="font-size:0.7rem">å³</span>
                    <label class="switch"><input type="checkbox" id="b-side"><span class="slider-toggle"></span></label>
                    <span style="font-size:0.7rem">å·¦</span>
                </div>
            </div>
            <div style="background:#fefefe; padding:10px; border-radius:8px; border:1px solid #ddd;">
                <label style="font-size:0.75rem; font-weight:bold;">ğŸ” è¡¨ç¤ºãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ (ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ãƒ»å±¥æ­´):</label>
                <select id="filter-matchup" class="analysis-select" onchange="refreshUI()">
                    <option value="All">å…¨ã¦ã®ãƒãƒƒãƒã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º</option>
                    <option value="R-R">å³æŠ• vs å³æ‰“ (R-R)</option>
                    <option value="R-L">å³æŠ• vs å·¦æ‰“ (R-L)</option>
                    <option value="L-R">å·¦æŠ• vs å³æ‰“ (L-R)</option>
                    <option value="L-L">å·¦æŠ• vs å·¦æ‰“ (L-L)</option>
                </select>
                <select id="filter-type" class="analysis-select" onchange="refreshUI()">
                    <option value="All">å…¨ã¦ã®çƒç¨®ã‚’è¡¨ç¤º</option>
                    <option value="ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ">ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ</option><option value="ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼">ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼</option><option value="ã‚«ãƒ¼ãƒ–">ã‚«ãƒ¼ãƒ–</option>
                    <option value="ãƒ•ã‚©ãƒ¼ã‚¯">ãƒ•ã‚©ãƒ¼ã‚¯</option><option value="ãƒã‚§ãƒ³ã‚¸">ãƒã‚§ãƒ³ã‚¸</option><option value="ã‚·ãƒ¥ãƒ¼ãƒˆ">ã‚·ãƒ¥ãƒ¼ãƒˆ</option>
                </select>
            </div>
            <button class="btn btn-clear" onclick="clearAllData()">âš ï¸ ãƒ‡ãƒ¼ã‚¿ã‚’å…¨ã¦æ¶ˆå»ã—ã¦ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
    </details>

    <div class="app-main">
        <div id="pitch-canvas-container">
            <canvas id="heatmap-layer" width="300" height="360"></canvas>
            <div id="strike-zone-box"></div>
        </div>

        <div class="control-grid">
            <div style="text-align:center;">
                <span id="speed-num" style="font-size:1.5rem; font-weight:bold; color:var(--accent)">140</span> <small>km/h</small>
                <input type="range" id="speed-slider" min="80" max="170" value="140" oninput="document.getElementById('speed-num').innerText = this.value" style="width:100%">
            </div>

            <div class="flex-row">
                <div class="pitch-compass" id="compass"></div>
                <div class="result-group">
                    <button class="res-btn active" onclick="setRes(this,'ç©ºæŒ¯ã‚Š')">ç©ºæŒ¯ã‚Š</button>
                    <button class="res-btn" onclick="setRes(this,'è¦‹é€ƒã—')">è¦‹é€ƒã—</button>
                    <button class="res-btn" onclick="setRes(this,'å®‰æ‰“')">å®‰æ‰“</button>
                    <button class="res-btn" onclick="setRes(this,'å‡¡æ‰“')">å‡¡æ‰“</button>
                    <button class="res-btn" onclick="setRes(this,'ãƒ•ã‚¡ã‚¦ãƒ«')">ãƒ•ã‚¡ã‚¦ãƒ«</button>
                    <button class="res-btn" onclick="setRes(this,'ãƒœãƒ¼ãƒ«')">ãƒœãƒ¼ãƒ«</button>
                </div>
            </div>

            <div class="flex-row">
                <button class="btn btn-record" onclick="recordPitch()">æŠ•çƒã‚’è¨˜éŒ²</button>
                <button class="btn btn-csv" onclick="downloadCSV()">CSVä¿å­˜</button>
            </div>
        </div>

        <div class="history">
            <table>
                <thead><tr><th>No</th><th>æŠ•æ‰‹-æ‰“è€…</th><th>çƒç¨®</th><th>çµæœ</th><th>æ¶ˆ</th></tr></thead>
                <tbody id="log-body"></tbody>
            </table>
        </div>
    </div>

    <script>
        let currentX = null, currentY = null, selectedType = 'ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ', selectedResult = 'ç©ºæŒ¯ã‚Š';
        let pitchData = JSON.parse(localStorage.getItem('pitchData_master')) || [];

        const pitchColors = { 'ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ': '#e74c3c', 'ã‚«ãƒ¼ãƒ–': '#3498db', 'ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼': '#2ecc71', 'ãƒ•ã‚©ãƒ¼ã‚¯': '#f39c12', 'ãƒã‚§ãƒ³ã‚¸': '#9b59b6', 'ã‚·ãƒ¥ãƒ¼ãƒˆ': '#1abc9c', 'ã‚·ãƒ³ã‚«ãƒ¼': '#d35400', 'ã‚«ãƒƒãƒˆ': '#34495e', 'ãƒ©ã‚¤ã‚º': '#f1c40f' };
        const compassMap = [
            { pos: 'ul', arrow: 'â†–', rLabel: 'ã‚«ãƒ¼ãƒ–', lLabel: 'ã‚«ãƒƒãƒˆ' }, { pos: 'u',  arrow: 'â†‘', rLabel: 'ãƒ©ã‚¤ã‚º', lLabel: 'ãƒ©ã‚¤ã‚º' }, { pos: 'ur', arrow: 'â†—', rLabel: 'ã‚«ãƒƒãƒˆ', lLabel: 'ã‚«ãƒ¼ãƒ–' },
            { pos: 'l',  arrow: 'â†', rLabel: 'ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼', lLabel: 'ã‚·ãƒ¥ãƒ¼ãƒˆ' }, { pos: 'c',  arrow: 'â—¯', rLabel: 'ç›´çƒ', lLabel: 'ç›´çƒ' }, { pos: 'r',  arrow: 'â†’', rLabel: 'ã‚·ãƒ¥ãƒ¼ãƒˆ', lLabel: 'ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼' },
            { pos: 'dl', arrow: 'â†™', rLabel: 'ãƒã‚§ãƒ³ã‚¸', lLabel: 'ã‚·ãƒ³ã‚«ãƒ¼' }, { pos: 'd',  arrow: 'â†“', rLabel: 'ãƒ•ã‚©ãƒ¼ã‚¯', lLabel: 'ãƒ•ã‚©ãƒ¼ã‚¯' }, { pos: 'dr', arrow: 'â†˜', rLabel: 'ã‚·ãƒ³ã‚«ãƒ¼', lLabel: 'ãƒã‚§ãƒ³ã‚¸' }
        ];

        function renderCompass() {
            const isLeft = document.getElementById('p-hand').checked;
            const container = document.getElementById('compass');
            container.innerHTML = '';
            compassMap.forEach(item => {
                const label = isLeft ? item.lLabel : item.rLabel;
                const real = (label === 'ç›´çƒ' ? 'ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ' : label);
                const btn = document.createElement('button');
                btn.className = `pitch-btn ${selectedType === real ? 'active' : ''}`;
                btn.innerHTML = `${item.arrow}<span>${label}</span>`;
                btn.onclick = () => { selectedType = real; renderCompass(); };
                container.appendChild(btn);
            });
        }

        function setRes(btn, r) { document.querySelectorAll('.res-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); selectedResult = r; }

        const canvasContainer = document.getElementById('pitch-canvas-container');
        function handleIn(e) {
            const rect = canvasContainer.getBoundingClientRect();
            const cx = e.touches ? e.touches[0].clientX : e.clientX;
            const cy = e.touches ? e.touches[0].clientY : e.clientY;
            currentX = Math.round(((cx - rect.left) / rect.width) * 300);
            currentY = Math.round(((cy - rect.top) / rect.height) * 360);
            document.querySelectorAll('.temp').forEach(m => m.remove());
            const t = document.createElement('div'); t.className = 'marker temp';
            t.style.left = (currentX/300*100)+'%'; t.style.top = (currentY/360*100)+'%';
            t.style.background = '#000'; canvasContainer.appendChild(t);
        }
        canvasContainer.addEventListener('mousedown', handleIn);
        canvasContainer.addEventListener('touchstart', (e) => { e.preventDefault(); handleIn(e); });

        function recordPitch() {
            if (currentX === null) return alert("ã‚³ãƒ¼ã‚¹ã‚’é¸æŠï¼");
            const ph = document.getElementById('p-hand').checked ? "L" : "R";
            const bs = document.getElementById('b-side').checked ? "L" : "R";
            const data = {
                id: Date.now(),
                pName: document.getElementById('p-name').value, pHand: ph,
                bName: document.getElementById('b-name').value, bSide: bs,
                matchup: `${ph}-${bs}`,
                type: selectedType, res: selectedResult,
                speed: document.getElementById('speed-slider').value,
                x: currentX, y: currentY
            };
            pitchData.push(data);
            localStorage.setItem('pitchData_master', JSON.stringify(pitchData));
            refreshUI();
            currentX = null; document.querySelectorAll('.temp').forEach(m => m.remove());
        }

        function deletePitch(id) { if(confirm("æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) { pitchData = pitchData.filter(p => p.id !== id); localStorage.setItem('pitchData_master', JSON.stringify(pitchData)); refreshUI(); } }
        function clearAllData() { if(confirm("å…¨ã¦ã®è¨˜éŒ²ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { pitchData = []; localStorage.removeItem('pitchData_master'); refreshUI(); } }

        function refreshUI() {
            const mFilter = document.getElementById('filter-matchup').value;
            const tFilter = document.getElementById('filter-type').value;
            const tbody = document.getElementById('log-body');
            tbody.innerHTML = '';
            
            const filtered = pitchData.filter(p => (mFilter==='All' || p.matchup===mFilter) && (tFilter==='All' || p.type===tFilter));
            
            [...filtered].reverse().forEach((p, i) => {
                const row = tbody.insertRow();
                row.innerHTML = `<td>${filtered.length-i}</td>
                    <td style="line-height:1.2">${p.pName}<br><span class="matchup-tag">${p.matchup}</span><br>${p.bName}</td>
                    <td>${p.type}</td><td>${p.res}</td>
                    <td><button onclick="deletePitch(${p.id})" style="border:none; background:var(--danger); color:#fff; border-radius:3px;">Ã—</button></td>`;
            });

            const cv = document.getElementById('heatmap-layer'); const ctx = cv.getContext('2d');
            ctx.clearRect(0, 0, 300, 360); document.querySelectorAll('.marker:not(.temp)').forEach(m => m.remove());
            filtered.forEach(p => {
                const m = document.createElement('div'); m.className = 'marker';
                m.style.left = (p.x/300*100)+'%'; m.style.top = (p.y/360*100)+'%';
                m.style.background = pitchColors[p.type] || '#fff'; canvasContainer.appendChild(m);
                const g = ctx.createRadialGradient(p.x, p.y, 5, p.x, p.y, 25);
                g.addColorStop(0, 'rgba(255, 69, 0, 0.4)'); g.addColorStop(1, 'rgba(255, 255, 255, 0)');
                ctx.fillStyle = g; ctx.fillRect(p.x - 25, p.y - 25, 50, 50);
            });
        }

        function downloadCSV() {
            let c = "No,Pitcher,P-Hand,Batter,B-Side,Matchup,Type,Result,Speed,X,Y\n";
            pitchData.forEach((p, i) => c += `${i+1},${p.pName},${p.pHand},${p.bName},${p.bSide},${p.matchup},${p.type},${p.res},${p.speed},${p.x},${p.y}\n`);
            const b = new Blob([c], { type: 'text/csv' }); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'pitch_master_log.csv'; a.click();
        }

        renderCompass(); refreshUI();
    </script>
</body>
</html>
