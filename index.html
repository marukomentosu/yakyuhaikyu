<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Elite Scout - Pitch Select | htmlãƒãƒ³</title>
    <style>
        :root { --primary: #0a2e5c; --accent: #e63946; --bg: #f0f2f5; --success: #2b9348; --undo: #f39c12; --danger: #d90429; --share: #00b900; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, sans-serif; }
        
        body { margin: 0; padding: 4px; height: 100vh; width: 100vw; overflow: hidden; background: var(--bg); display: flex; flex-direction: column; }

        .header { flex: 0 0 auto; display: flex; justify-content: space-between; align-items: center; background: var(--primary); color: white; padding: 6px 12px; border-radius: 8px; margin-bottom: 4px; }
        .header h1 { font-size: 0.85rem; margin: 0; }
        .btn-settings { background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; }

        .main-layout { flex: 1; display: flex; flex-direction: column; min-height: 0; gap: 4px; }

        /* ã‚¾ãƒ¼ãƒ³ï¼ˆè¦‹åˆ‡ã‚Œãªã„ã‚ˆã†æœ€å¤§åŒ–ï¼‰ */
        .map-area { flex: 1.4; display: flex; justify-content: center; align-items: center; position: relative; min-height: 0; }
        #canvas-wrap { position: relative; height: 98%; aspect-ratio: 3 / 3.6; background: #333; border: 3px solid #111; border-radius: 10px; touch-action: none; }
        #s-zone { position: absolute; top: 22%; left: 21%; width: 58%; height: 56%; border: 1.5px solid rgba(255,255,255,0.4); pointer-events: none; }
        canvas#h-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .dot { position: absolute; width: 14px; height: 14px; border-radius: 50%; transform: translate(-50%, -50%); border: 1.5px solid #fff; pointer-events: none; z-index: 5; }

        /* æ“ä½œãƒ‘ãƒãƒ« */
        .ctrl-panel { flex: 0 0 auto; background: #fff; padding: 6px; border-radius: 10px; }
        .speed-row { display: none; align-items: center; gap: 8px; margin-bottom: 4px; }
        .speed-txt { font-size: 0.8rem; font-weight: bold; color: var(--accent); min-width: 75px; }

        .compass { display: flex; flex-wrap: wrap; justify-content: center; gap: 4px; }
        .p-btn { width: 31%; aspect-ratio: 2/1; border: 2px solid #ddd; border-radius: 8px; background: #fff; font-size: 0.9rem; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; }
        .p-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .p-btn span { font-size: 0.5rem; margin-top: 1px; }

        .action-row { display: grid; grid-template-columns: 1fr 2fr; gap: 6px; margin-top: 6px; }
        .btn-main { padding: 10px; border: none; border-radius: 8px; font-weight: bold; color: #fff; font-size: 0.95rem; }
        .b-undo { background: var(--undo); }
        .b-rep { background: var(--success); }

        /* å±¥æ­´ï¼ˆãƒ¢ãƒã‚¯ãƒ­ï¼‰ */
        .history-list { flex: 0.7; overflow-y: auto; background: #fff; border-radius: 8px; border: 1px solid #ddd; margin-top: 2px; }
        .h-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; text-align: center; }
        .h-table th { background: #eee; position: sticky; top: 0; padding: 4px; font-size: 0.65rem; color: #333; }
        .h-table td { border-bottom: 1px solid #f0f0f0; padding: 4px; color: #333; }
        .h-table tr:first-child td { font-weight: bold; background: #f9f9f9; }

        /* è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center; padding: 10px; }
        .modal-content { background: #fff; width: 100%; max-width: 350px; padding: 15px; border-radius: 12px; max-height: 90vh; overflow-y: auto; }
        .m-row { margin-bottom: 12px; }
        .m-row label { display: block; font-size: 0.7rem; font-weight: bold; margin-bottom: 4px; }
        .m-input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem; }
        
        .pitch-selector { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; background: #f8f9fa; padding: 8px; border-radius: 8px; }
        .pitch-opt { display: flex; align-items: center; gap: 4px; font-size: 0.75rem; }
        .pitch-opt input { width: 16px; height: 16px; }

        .sw-group { display: flex; align-items: center; justify-content: space-between; background: #f0f0f0; padding: 6px 10px; border-radius: 15px; font-size: 0.75rem; }
        .switch { position: relative; width: 36px; height: 18px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: #ccc; transition: .4s; border-radius: 20px; cursor: pointer; }
        .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background: var(--primary); }
        input:checked + .slider:before { transform: translateX(18px); }

        #report-img { width: 100%; border-radius: 6px; margin: 8px 0; border: 1px solid #ccc; }
        .share-btn { background: var(--share); color: white; width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="header">
        <h1 id="title-label">æŠ•æ‰‹A vs æ‰“è€…A</h1>
        <button class="btn-settings" onclick="openModal('settings-modal')">âš™ï¸ è¨­å®š</button>
    </div>

    <div class="main-layout">
        <div class="map-area">
            <div id="canvas-wrap">
                <canvas id="h-layer" width="300" height="360"></canvas>
                <div id="s-zone"></div>
            </div>
        </div>
        
        <div class="ctrl-panel">
            <div id="sp-area" class="speed-row">
                <span id="sp-val" class="speed-txt">140 km/h</span>
                <input type="range" id="sp-sld" min="80" max="170" value="140" oninput="document.getElementById('sp-val').innerText=this.value+' km/h'" style="flex:1;">
            </div>
            
            <div class="compass" id="comp"></div>
            
            <div class="action-row">
                <button class="btn-main b-undo" onclick="undo()">å–ã‚Šæ¶ˆã—</button>
                <button class="btn-main b-rep" onclick="generateReport()">ãƒ¬ãƒãƒ¼ãƒˆä½œæˆãƒ»å…±æœ‰</button>
            </div>
        </div>
        
        <div class="history-list">
            <table class="h-table">
                <thead><tr><th>#</th><th>çƒç¨®</th><th>çƒé€Ÿ</th></tr></thead>
                <tbody id="h-body"></tbody>
            </table>
        </div>
    </div>

    <div id="settings-modal" class="modal" onclick="closeModal(event, 'settings-modal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 style="margin-top:0">âš™ï¸ è©¦åˆè¨­å®š</h3>
            <div class="m-row"><label>æŠ•æ‰‹ / æ‰“è€…</label>
                <input type="text" id="p-name" class="m-input" value="æŠ•æ‰‹A" onchange="syncUI()" style="margin-bottom:4px">
                <div class="sw-group"><span>å³æŠ•</span><label class="switch"><input type="checkbox" id="p-hand" onchange="syncUI()"><span class="slider"></span></label><span>å·¦æŠ•</span></div>
                <input type="text" id="b-name" class="m-input" value="æ‰“è€…A" onchange="syncUI()" style="margin:4px 0">
                <div class="sw-group"><span>å³æ‰“</span><label class="switch"><input type="checkbox" id="b-side" onchange="syncUI()"><span class="slider"></span></label><span>å·¦æ‰“</span></div>
            </div>

            <div class="m-row">
                <label>çƒç¨®è¡¨ç¤ºè¨­å®š</label>
                <div class="pitch-selector" id="pitch-config"></div>
            </div>

            <div class="m-row"><div class="sw-group"><span>çƒé€Ÿ OFF</span><label class="switch"><input type="checkbox" id="sp-on" onchange="syncUI()"><span class="slider"></span></label><span>ON</span></div></div>
            
            <button onclick="document.getElementById('settings-modal').style.display='none'" class="btn-main" style="width:100%; background:var(--primary)">å®Œäº†</button>
            <button onclick="resetAll()" style="width:100%; margin-top:12px; background:none; border:none; color:var(--danger); font-size:0.7rem;">å…¨è¨˜éŒ²æ¶ˆå»</button>
        </div>
    </div>

    <div id="report-modal" class="modal" onclick="closeModal(event, 'report-modal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 style="margin:0">ğŸ“¸ ãƒ¬ãƒãƒ¼ãƒˆå®Œæˆ</h3>
            <img id="report-img" src="">
            <button class="share-btn" onclick="shareReport()">ğŸ“¤ ã‚¢ãƒ—ãƒªã§å…±æœ‰ã™ã‚‹</button>
            <button onclick="document.getElementById('report-modal').style.display='none'" class="btn-main" style="width:100%; margin-top:8px; background:#666;">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script>
        let db=[], selT='ç›´çƒ', reportBlob=null;
        const colors = {'ç›´çƒ':'#e74c3c','ã‚«ãƒ¼ãƒ–':'#3498db','ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼':'#2ecc71','ãƒ•ã‚©ãƒ¼ã‚¯':'#f39c12','ãƒã‚§ãƒ³ã‚¸':'#9b59b6','ã‚·ãƒ¥ãƒ¼ãƒˆ':'#1abc9c','ã‚·ãƒ³ã‚«ãƒ¼':'#d35400','ã‚«ãƒƒãƒˆ':'#34495e','ãƒ©ã‚¤ã‚º':'#f1c40f'};
        const pitchLayout = [{a:'â†–', r:'ã‚«ãƒƒãƒˆ', l:'ã‚·ãƒ¥ãƒ¼ãƒˆ'}, {a:'â†‘', r:'ãƒ©ã‚¤ã‚º', l:'ãƒ©ã‚¤ã‚º'}, {a:'â†—', r:'ã‚·ãƒ¥ãƒ¼ãƒˆ', l:'ã‚«ãƒƒãƒˆ'},{a:'â†', r:'ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼', l:'ã‚·ãƒ³ã‚«ãƒ¼'}, {a:'â—¯', r:'ç›´çƒ', l:'ç›´çƒ'}, {a:'â†’', r:'ã‚·ãƒ³ã‚«ãƒ¼', l:'ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼'},{a:'â†™', r:'ã‚«ãƒ¼ãƒ–', l:'ãƒã‚§ãƒ³ã‚¸'}, {a:'â†“', r:'ãƒ•ã‚©ãƒ¼ã‚¯', l:'ãƒ•ã‚©ãƒ¼ã‚¯'}, {a:'â†˜', r:'ãƒã‚§ãƒ³ã‚¸', l:'ã‚«ãƒ¼ãƒ–'}];
        
        // çƒç¨®ã®æœ‰åŠ¹çŠ¶æ…‹ï¼ˆåˆæœŸã¯å…¨éƒ¨ONï¼‰
        let enabledPitches = {'ç›´çƒ':true, 'ã‚«ãƒ¼ãƒ–':true, 'ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼':true, 'ãƒ•ã‚©ãƒ¼ã‚¯':true, 'ãƒã‚§ãƒ³ã‚¸':true, 'ã‚·ãƒ¥ãƒ¼ãƒˆ':true, 'ã‚·ãƒ³ã‚«ãƒ¼':true, 'ã‚«ãƒƒãƒˆ':true, 'ãƒ©ã‚¤ã‚º':true};

        function initPitchConfig() {
            const container = document.getElementById('pitch-config');
            container.innerHTML = '';
            Object.keys(enabledPitches).forEach(p => {
                const div = document.createElement('div');
                div.className = 'pitch-opt';
                div.innerHTML = `<input type="checkbox" id="chk-${p}" ${enabledPitches[p]?'checked':''} onchange="togglePitch('${p}')"> <label for="chk-${p}">${p}</label>`;
                container.appendChild(div);
            });
        }

        function togglePitch(name) {
            enabledPitches[name] = document.getElementById(`chk-${name}`).checked;
            // ç¾åœ¨ã®é¸æŠçƒç¨®ãŒç„¡åŠ¹ã«ãªã£ãŸã‚‰ç›´çƒã«æˆ»ã™
            if (!enabledPitches[selT]) selT = 'ç›´çƒ';
            syncUI();
        }

        function syncUI() {
            const isL = document.getElementById('p-hand').checked;
            document.getElementById('title-label').innerText = `${document.getElementById('p-name').value}(${isL?'L':'R'}) vs ${document.getElementById('b-name').value}(${document.getElementById('b-side').checked?'L':'R'})`;
            document.getElementById('sp-area').style.display = document.getElementById('sp-on').checked ? 'flex' : 'none';

            const comp = document.getElementById('comp'); 
            comp.innerHTML = '';
            pitchLayout.forEach(item => {
                const label = isL ? item.l : item.r;
                if (!enabledPitches[label]) return; // ç„¡åŠ¹ãªçƒç¨®ã¯è¡¨ç¤ºã—ãªã„

                const btn = document.createElement('button'); 
                btn.className = `p-btn ${selT === label ? 'active' : ''}`;
                btn.innerHTML = `${item.a}<span>${label}</span>`; 
                btn.onclick = () => { selT = label; syncUI(); };
                comp.appendChild(btn);
            });
            drawMap(); updateHistory();
        }

        const wrap = document.getElementById('canvas-wrap');
        function handleTouch(e) {
            e.preventDefault();
            const r=wrap.getBoundingClientRect(); 
            const xVal = e.touches ? e.touches[0].clientX : e.clientX;
            const yVal = e.touches ? e.touches[0].clientY : e.clientY;
            const x = Math.round(((xVal - r.left) / r.width) * 300);
            const y = Math.round(((yVal - r.top) / r.height) * 360);
            const spVal = document.getElementById('sp-on').checked ? document.getElementById('sp-sld').value + " km/h" : "-";
            db.push({t:selT, x:x, y:y, s:spVal});
            drawMap(); updateHistory();
        }
        wrap.addEventListener('touchstart', handleTouch);
        wrap.addEventListener('mousedown', handleTouch);

        function undo() {
            if(db.length > 0) { db.pop(); drawMap(); updateHistory(); }
        }

        function updateHistory() {
            const body = document.getElementById('h-body');
            body.innerHTML = db.length === 0 ? '<tr><td colspan="3" style="padding:15px;color:#999">ã‚¿ãƒƒãƒã—ã¦è¨˜éŒ²</td></tr>' : '';
            [...db].reverse().forEach((p, i) => {
                const row = body.insertRow();
                row.innerHTML = `<td>${db.length-i}</td><td>${p.t}</td><td>${p.s}</td>`;
            });
        }

        function drawMap() {
            const ctx = document.getElementById('h-layer').getContext('2d'); ctx.clearRect(0,0,300,360);
            document.querySelectorAll('.dot').forEach(m=>m.remove());
            db.forEach(p => {
                const m=document.createElement('div'); m.className='dot'; m.style.left=(p.x/300*100)+'%'; m.style.top=(p.y/360*100)+'%'; m.style.background=colors[p.t]||'#fff'; wrap.appendChild(m);
            });
        }

        async function generateReport() {
            if(db.length === 0) return alert("è¨˜éŒ²ãªã—");
            const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
            canvas.width = 600; canvas.height = 800;
            ctx.fillStyle = "#fff"; ctx.fillRect(0,0,600,800);
            ctx.fillStyle = "#0a2e5c"; ctx.fillRect(0,0,600,80);
            ctx.fillStyle = "#fff"; ctx.font = "bold 26px sans-serif"; ctx.fillText("PITCHING REPORT", 30, 50);
            ctx.fillStyle = "#333"; ctx.font = "bold 22px sans-serif"; ctx.fillText(document.getElementById('title-label').innerText, 30, 120);
            ctx.save(); ctx.translate(30, 160); ctx.fillStyle = "#222"; ctx.fillRect(0,0,300,360);
            ctx.strokeStyle = "rgba(255,255,255,0.4)"; ctx.strokeRect(300*0.21, 360*0.22, 300*0.58, 360*0.56);
            db.forEach(p => { ctx.fillStyle = colors[p.t]; ctx.beginPath(); ctx.arc(p.x, p.y, 8, 0, Math.PI*2); ctx.fill(); ctx.strokeStyle="#fff"; ctx.stroke(); }); ctx.restore();
            ctx.fillStyle = "#000"; ctx.font = "bold 18px sans-serif"; ctx.fillText("ã€Historyã€‘", 350, 180);
            db.slice(-15).reverse().forEach((p,i) => { ctx.font = "14px sans-serif"; ctx.fillText(`${db.length-i}. ${p.t} (${p.s})`, 350, 210+(i*24)); });
            document.getElementById('report-img').src = canvas.toDataURL("image/png");
            canvas.toBlob(blob => { reportBlob = blob; }, "image/png");
            openModal('report-modal');
        }

        async function shareReport() {
            if (!reportBlob) return;
            const file = new File([reportBlob], "report.png", { type: "image/png" });
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                try { await navigator.share({ files: [file], title: 'æŠ•çƒãƒ¬ãƒãƒ¼ãƒˆ', text: document.getElementById('title-label').innerText }); } catch (e) {}
            } else { alert("ç”»åƒã‚’é•·æŠ¼ã—ä¿å­˜ã—ã¦ãã ã•ã„"); }
        }

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(e, id) { if(e.target.id === id) document.getElementById(id).style.display = 'none'; }
        function resetAll() { if(confirm("æ¶ˆå»ï¼Ÿ")) { db = []; drawMap(); syncUI(); } }
        
        initPitchConfig();
        syncUI();
    </script>
</body>
</html>
