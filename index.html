<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Elite Scout - Share | htmlãƒãƒ³</title>
    <style>
        :root { --primary: #0a2e5c; --accent: #e63946; --bg: #f0f2f5; --success: #2b9348; --danger: #d90429; --share: #00b900; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, sans-serif; }
        body { margin: 0; padding: 4px; height: 100vh; overflow: hidden; background: var(--bg); display: flex; flex-direction: column; }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header { display: flex; justify-content: space-between; align-items: center; background: var(--primary); color: white; padding: 6px 12px; border-radius: 8px; margin-bottom: 4px; }
        .header h1 { font-size: 0.9rem; margin: 0; }
        .btn-settings { background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; font-weight: bold; }

        /* ãƒ¡ã‚¤ãƒ³ */
        .main-layout { flex: 1; display: flex; flex-direction: column; gap: 4px; min-height: 0; }
        .map-area { flex: 1; display: flex; justify-content: center; align-items: center; position: relative; }
        #canvas-wrap { position: relative; width: 100%; max-width: 210px; aspect-ratio: 3 / 3.6; background: #333; border: 3px solid #111; border-radius: 10px; }
        #s-zone { position: absolute; top: 22%; left: 21%; width: 58%; height: 56%; border: 1.5px solid rgba(255,255,255,0.3); pointer-events: none; }
        canvas#h-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .dot { position: absolute; width: 12px; height: 12px; border-radius: 50%; transform: translate(-50%, -50%); border: 1.5px solid #fff; pointer-events: none; }

        /* æ“ä½œãƒ‘ãƒãƒ« */
        .ctrl-panel { background: #fff; padding: 8px; border-radius: 12px; }
        .speed-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .speed-txt { font-size: 1rem; font-weight: bold; color: var(--accent); min-width: 75px; }

        .input-grid { display: grid; grid-template-columns: 1fr 90px; gap: 8px; }
        .compass { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; }
        .p-btn { aspect-ratio: 1.2/1; border: 2px solid #ddd; border-radius: 10px; background: #fff; font-size: 1.1rem; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; }
        .p-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .p-btn span { font-size: 0.55rem; margin-top: 2px; }

        .res-grid { display: grid; grid-template-columns: 1fr; gap: 4px; }
        .r-btn { font-size: 0.8rem; font-weight: bold; border: 1.5px solid #eee; border-radius: 8px; background: #f8f9fa; }
        .r-btn.active { background: #555; color: white; }

        .action-row { display: grid; grid-template-columns: 1.5fr 1fr; gap: 6px; margin-top: 8px; }
        .btn-main { padding: 14px; border: none; border-radius: 10px; font-weight: bold; color: #fff; font-size: 1.1rem; }
        .b-rec { background: var(--primary); }
        .b-rep { background: var(--success); font-size: 0.9rem; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center; padding: 15px; }
        .modal-content { background: #fff; width: 100%; max-width: 350px; padding: 20px; border-radius: 16px; position: relative; max-height: 90vh; overflow-y: auto; }
        
        .m-row { margin-bottom: 12px; }
        .m-row label { display: block; font-size: 0.8rem; font-weight: bold; margin-bottom: 4px; }
        .m-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
        .sw-group { display: flex; align-items: center; justify-content: space-between; background: #f0f0f0; padding: 8px 12px; border-radius: 20px; }
        .switch { position: relative; width: 44px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: #ccc; transition: .4s; border-radius: 34px; cursor: pointer; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background: var(--primary); }
        input:checked + .slider:before { transform: translateX(22px); }

        /* ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤ºç”¨ */
        #report-img { width: 100%; border: 1px solid #ccc; border-radius: 8px; margin: 10px 0; }
        .share-btn { background: var(--share); color: white; width: 100%; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
    </style>
</head>
<body>

    <div class="header">
        <h1 id="title-label">æŠ•æ‰‹A vs æ‰“è€…A</h1>
        <button class="btn-settings" onclick="openModal('settings-modal')">âš™ï¸ è¨­å®š</button>
    </div>

    <div class="main-layout">
        <div class="map-area">
            <div id="canvas-wrap">
                <canvas id="h-layer" width="300" height="360"></canvas>
                <div id="s-zone"></div>
            </div>
        </div>
        <div class="ctrl-panel">
            <div id="sp-area" class="speed-row">
                <span id="sp-val" class="speed-txt">140 km/h</span>
                <input type="range" id="sp-sld" min="80" max="170" value="140" oninput="document.getElementById('sp-val').innerText=this.value+' km/h'" style="flex:1;">
            </div>
            <div class="input-grid">
                <div class="compass" id="comp"></div>
                <div class="res-grid">
                    <button class="r-btn active" onclick="setR(this,'ç©ºæŒ¯ã‚Š')">ç©ºæŒ¯</button>
                    <button class="r-btn" onclick="setR(this,'è¦‹é€ƒã—')">è¦‹é€ƒ</button>
                    <button class="r-btn" onclick="setR(this,'å®‰æ‰“')">å®‰æ‰“</button>
                    <button class="r-btn" onclick="setR(this,'å‡¡æ‰“')">å‡¡æ‰“</button>
                </div>
            </div>
            <div class="action-row">
                <button class="btn-main b-rec" onclick="record()">æŠ•çƒè¨˜éŒ²</button>
                <button class="btn-main b-rep" onclick="generateReport()">ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal" onclick="closeModal(event, 'settings-modal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3>âš™ï¸ è©¦åˆè¨­å®š</h3>
            <div class="m-row"><label>æŠ•æ‰‹å</label><input type="text" id="p-name" class="m-input" value="æŠ•æ‰‹A" onchange="syncUI()">
                <div class="sw-group"><span>å³æŠ•</span><label class="switch"><input type="checkbox" id="p-hand" onchange="syncUI()"><span class="slider"></span></label><span>å·¦æŠ•</span></div>
            </div>
            <div class="m-row"><label>æ‰“è€…å</label><input type="text" id="b-name" class="m-input" value="æ‰“è€…A" onchange="syncUI()">
                <div class="sw-group"><span>å³æ‰“</span><label class="switch"><input type="checkbox" id="b-side" onchange="syncUI()"><span class="slider"></span></label><span>å·¦æ‰“</span></div>
            </div>
            <div class="m-row"><div class="sw-group"><span>çƒé€Ÿ OFF</span><label class="switch"><input type="checkbox" id="sp-on" checked onchange="syncUI()"><span class="slider"></span></label><span>ON</span></div></div>
            <button onclick="document.getElementById('settings-modal').style.display='none'" class="btn-main b-rec" style="width:100%">å®Œäº†</button>
            <button onclick="resetAll()" style="width:100%; margin-top:10px; background:none; border:none; color:var(--danger); font-size:0.75rem;">å…¨ãƒ‡ãƒ¼ã‚¿æ¶ˆå»</button>
        </div>
    </div>

    <div id="report-modal" class="modal" onclick="closeModal(event, 'report-modal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 style="margin:0">ğŸ“¸ ãƒ¬ãƒãƒ¼ãƒˆå…±æœ‰</h3>
            <img id="report-img" src="" alt="Report">
            <button class="btn-main share-btn" id="share-api-btn" onclick="shareReport()">
                <span>ğŸ“¤ ã‚¢ãƒ—ãƒªã§å…±æœ‰ã™ã‚‹</span>
            </button>
            <p id="share-fallback" style="font-size:0.6rem; color:#666; text-align:center; margin-top:5px; display:none;">â€»å…±æœ‰ãƒœã‚¿ãƒ³ãŒå‹•ã‹ãªã„å ´åˆã¯ç”»åƒã‚’é•·æŠ¼ã—ä¿å­˜ã—ã¦ãã ã•ã„</p>
            <button onclick="document.getElementById('report-modal').style.display='none'" class="btn-main b-rec" style="width:100%; margin-top:10px;">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script>
        let curX=null, curY=null, selT='ç›´çƒ', selR='ç©ºæŒ¯ã‚Š', db=[], reportBlob=null;
        const colors = {'ç›´çƒ':'#e74c3c','ã‚«ãƒ¼ãƒ–':'#3498db','ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼':'#2ecc71','ãƒ•ã‚©ãƒ¼ã‚¯':'#f39c12','ãƒã‚§ãƒ³ã‚¸':'#9b59b6','ã‚·ãƒ¥ãƒ¼ãƒˆ':'#1abc9c','ã‚·ãƒ³ã‚«ãƒ¼':'#d35400','ã‚«ãƒƒãƒˆ':'#34495e','ãƒ©ã‚¤ã‚º':'#f1c40f'};
        const pitchLayout = [{a:'â†–', r:'ã‚«ãƒƒãƒˆ', l:'ã‚·ãƒ¥ãƒ¼ãƒˆ'}, {a:'â†‘', r:'ãƒ©ã‚¤ã‚º', l:'ãƒ©ã‚¤ã‚º'}, {a:'â†—', r:'ã‚·ãƒ¥ãƒ¼ãƒˆ', l:'ã‚«ãƒƒãƒˆ'},{a:'â†', r:'ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼', l:'ã‚·ãƒ³ã‚«ãƒ¼'}, {a:'â—¯', r:'ç›´çƒ', l:'ç›´çƒ'}, {a:'â†’', r:'ã‚·ãƒ³ã‚«ãƒ¼', l:'ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼'},{a:'â†™', r:'ã‚«ãƒ¼ãƒ–', l:'ãƒã‚§ãƒ³ã‚¸'}, {a:'â†“', r:'ãƒ•ã‚©ãƒ¼ã‚¯', l:'ãƒ•ã‚©ãƒ¼ã‚¯'}, {a:'â†˜', r:'ãƒã‚§ãƒ³ã‚¸', l:'ã‚«ãƒ¼ãƒ–'}];

        function syncUI() {
            const isL = document.getElementById('p-hand').checked;
            document.getElementById('title-label').innerText = `${document.getElementById('p-name').value}(${isL?'L':'R'}) vs ${document.getElementById('b-name').value}(${document.getElementById('b-side').checked?'L':'R'})`;
            document.getElementById('sp-area').style.display = document.getElementById('sp-on').checked ? 'flex' : 'none';
            const comp = document.getElementById('comp'); comp.innerHTML = '';
            pitchLayout.forEach(item => {
                const label = isL ? item.l : item.r;
                const btn = document.createElement('button'); btn.className = `p-btn ${selT === label ? 'active' : ''}`;
                btn.innerHTML = `${item.a}<span>${label}</span>`; btn.onclick = () => { selT = label; syncUI(); };
                comp.appendChild(btn);
            });
            drawMap();
        }

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(e, id) { if(e.target.id === id) document.getElementById(id).style.display = 'none'; }
        function setR(b, r) { document.querySelectorAll('.r-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); selR=r; }

        const wrap = document.getElementById('canvas-wrap');
        function tap(e) {
            const r=wrap.getBoundingClientRect(); const x=e.touches?e.touches[0].clientX:e.clientX; const y=e.touches?e.touches[0].clientY:e.clientY;
            curX=Math.round(((x-r.left)/r.width)*300); curY=Math.round(((y-r.top)/r.height)*360);
            document.querySelectorAll('.tmp').forEach(m=>m.remove());
            const t=document.createElement('div'); t.className='dot tmp'; t.style.left=(curX/300*100)+'%'; t.style.top=(curY/360*100)+'%'; t.style.background='#000'; wrap.appendChild(t);
        }
        wrap.addEventListener('mousedown', tap); wrap.addEventListener('touchstart', e=>{ e.preventDefault(); tap(e); });

        function record() {
            if(curX===null) return alert("æŠ•çƒä½ç½®ã‚’ã‚¿ãƒƒãƒ—ï¼");
            db.push({t:selT, r:selR, x:curX, y:curY, s:document.getElementById('sp-on').checked?document.getElementById('sp-sld').value+"km":"-"});
            drawMap(); curX=null; document.querySelectorAll('.tmp').forEach(m=>m.remove());
        }

        function drawMap() {
            const ctx = document.getElementById('h-layer').getContext('2d'); ctx.clearRect(0,0,300,360);
            document.querySelectorAll('.dot:not(.tmp)').forEach(m=>m.remove());
            db.forEach(p => {
                const m=document.createElement('div'); m.className='dot'; m.style.left=(p.x/300*100)+'%'; m.style.top=(p.y/360*100)+'%'; m.style.background=colors[p.t]||'#fff'; wrap.appendChild(m);
            });
        }

        async function generateReport() {
            if(db.length === 0) return alert("è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“");
            const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
            canvas.width = 600; canvas.height = 800;
            ctx.fillStyle = "#ffffff"; ctx.fillRect(0,0,600,800);
            ctx.fillStyle = "#0a2e5c"; ctx.fillRect(0,0,600,80);
            ctx.fillStyle = "#ffffff"; ctx.font = "bold 26px sans-serif"; ctx.fillText("PITCHING REPORT", 30, 50);
            ctx.fillStyle = "#333"; ctx.font = "bold 20px sans-serif"; ctx.fillText(document.getElementById('title-label').innerText, 30, 120);
            ctx.save(); ctx.translate(30, 160); ctx.fillStyle = "#222"; ctx.fillRect(0,0,300,360);
            ctx.strokeStyle = "rgba(255,255,255,0.4)"; ctx.strokeRect(300*0.21, 360*0.22, 300*0.58, 360*0.56);
            db.forEach(p => { ctx.fillStyle = colors[p.t]; ctx.beginPath(); ctx.arc(p.x, p.y, 7, 0, Math.PI*2); ctx.fill(); ctx.strokeStyle="#fff"; ctx.stroke(); }); ctx.restore();
            ctx.fillStyle = "#000"; ctx.font = "bold 16px sans-serif"; ctx.fillText("ã€Recent Pitchesã€‘", 350, 180);
            db.slice(-15).reverse().forEach((p,i) => { ctx.font = "14px sans-serif"; ctx.fillText(`${db.length-i}. ${p.t}(${p.s}) - ${p.r}`, 350, 210+(i*22)); });
            
            const dataUrl = canvas.toDataURL("image/png");
            document.getElementById('report-img').src = dataUrl;
            
            // Blobä½œæˆï¼ˆå…±æœ‰ç”¨ï¼‰
            canvas.toBlob(blob => { reportBlob = blob; }, "image/png");
            openModal('report-modal');
            
            // å…±æœ‰APIãŒä½¿ãˆãªã„å ´åˆã®è­¦å‘Šè¡¨ç¤º
            if (!navigator.canShare) {
                document.getElementById('share-fallback').style.display = 'block';
            }
        }

        async function shareReport() {
            if (!reportBlob) return;
            const file = new File([reportBlob], "scout_report.png", { type: "image/png" });
            const shareData = { files: [file], title: 'æŠ•çƒãƒ¬ãƒãƒ¼ãƒˆ', text: document.getElementById('title-label').innerText };

            if (navigator.canShare && navigator.canShare(shareData)) {
                try { await navigator.share(shareData); } catch (e) { console.log("Share failed", e); }
            } else {
                alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ç›´æ¥å…±æœ‰ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚ç”»åƒã‚’é•·æŠ¼ã—ä¿å­˜ã—ã¦ãã ã•ã„ã€‚");
            }
        }

        function resetAll() { if(confirm("æ¶ˆå»ï¼Ÿ")) { db = []; drawMap(); syncUI(); } }
        syncUI();
    </script>
</body>
</html>
